name: Enable Inline l2 configuration in PacketFence
testcases:
#
# Need to fix issue it looks likes something is broken
#
#
#- name: configure_interface_inlinel2_as_type_inline_l2
#  steps:
#  - type: pf_api_interface_default
#    id: "inlinel2"
#    hwaddr: "92:ed:ee:36:e9:6a"
#    ifindex: "10"
#    name: "inlinel2"
#    network: null
#    network_iseditable: false
#    split_network: null
#    ipaddress": "{{.inline_l2.pf_portal}}"
#    netmask: "255.255.255.0"

- name: get_login_token
  steps:
  - type: get_login_token

- name: configure_interface_inlinel2_as_type_inline_l2
  steps:
  - type: http
    method: PATCH
    url: '{{.pfserver_webadmin_url}}/api/v1/config/interface/inlinel2'
    ignore_verify_ssl: true
    body: >-
     {
       "id": "inlinel2",
       "isClone": false,
       "isNew": false,
       "prefixRouteName": "",
       "additional_listening_daemons": [],
       "coa": null,
       "dhcpd_enabled": "enabled",
       "dns": "8.8.8.8",
       "high_availability": 0,
       "hwaddr": "92:ed:ee:36:e9:6a",
       "ifindex": "10",
       "ipv6_address": null,
       "ipv6_prefix": null,
       "is_running": true,
       "master": null,
       "name": "inlinel2",
       "nat_enabled": "enabled",
       "network": null,
       "network_iseditable": false,
       "networks": [],
       "not_editable": false,
       "reg_network": null,
       "split_network": null,
       "tenant_id": 1,
       "type": "inlinel2",
       "vip": null,
       "vlan": null,
       "ipaddress": "{{.inline_l2.pf_portal}}",
       "netmask": "255.255.255.0"
     }
    headers:
      "Authorization": "{{.get_login_token.result.token}}"
      "Content-Type": "application/json"
    assertions:
      - result.statuscode ShouldEqual 200

- name: configure_inline_l2_network
  steps:
  - type: pf_api_l2_network
    id: "{{.inline_l2.networks}}"
    dhcp_default_lease_time: "30"
    dhcp_end: "{{.inline_l2.node.ipaddress}}"
    dhcp_max_lease_time: "30"
    dhcp_start: "{{.inline_l2.node.ipaddress}}"
    dns: "8.8.8.8"
    netflow_accounting_enabled: "enabled"
    netmask: "255.255.255.0"
    type_tmp: "inlinel2"

- name: create_a_user
  steps:
  - type: pf_api_users_create
    user: "iastigmate"

- name: assign_a_password_to_the_user
  steps:
  - type: pf_api_user_add_password
    user: "iastigmate"
    expiration: "{{.inline_lx_iastigmate.password.expiration}}"
    password: "password"

- name: configure_snat_interface_for_passthroughs
  steps:
  - type: pf_api_base_network
    interfaceSNAT: "eth0"

- name: configure_snat_interface_for_inline
  steps:
  - type: pf_api_base_inline
    interfaceSNAT: "eth0"

- name: restart_iptables
  steps:
  - type: systemctl_service_restart
    service: packetfence-iptables

- name: restart_pfdns_service
  steps:
  - type: systemctl_service_restart
    service: packetfence-pfdns

- name: restart_pfdhcp_service
  steps:
  - type: systemctl_service_restart_without_check_status 
    service: packetfence-pfdhcp

- name: restart_haproxy-portal_service
  steps:
  - type: systemctl_service_restart
    service: packetfence-haproxy-portal

- name: restart_keepalived_service
  steps:
  - type: systemctl_service_restart
    service: packetfence-keepalived

- name: restart_pfdhcplistener_service
  steps:
  - type: systemctl_service_restart
    service: packetfence-pfdhcplistener

- name: restart_pfacct_service
  steps:
  - type: systemctl_service_restart
    service: packetfence-pfacct
