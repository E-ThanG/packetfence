---
- hosts: pfservers
  name: Run Fingerbank Invalid DB tests
  become: True

  vars:
    # put your test suites to try here
    test_suites:
      - configurator
      - global_config

      - fingerbank_invalid_db/corrupt
      - fingerbank_invalid_db/clear_cache
      - wired_mac_auth
      - wired_mac_auth/teardown
      - fingerbank_invalid_db/clear_cache
      - wireless_mac_auth
      - wireless_mac_auth/teardown
      - fingerbank_invalid_db/clear_cache
      - wired_dot1x_eap_peap
      - wired_dot1x_eap_peap/teardown
      - fingerbank_invalid_db/clear_cache
      - wireless_dot1x_eap_peap
      - wireless_dot1x_eap_peap/teardown
      - fingerbank_invalid_db/clear_cache
      - pfdhcplistener
      - pfdhcplistener/teardown
      - fingerbank_invalid_db/corrupt/teardown

      - fingerbank_invalid_db/missing_table
      - fingerbank_invalid_db/clear_cache
      - wired_mac_auth
      - wired_mac_auth/teardown
      - fingerbank_invalid_db/clear_cache
      - wireless_mac_auth
      - wireless_mac_auth/teardown
      - fingerbank_invalid_db/clear_cache
      - wired_dot1x_eap_peap
      - wired_dot1x_eap_peap/teardown
      - fingerbank_invalid_db/clear_cache
      - wireless_dot1x_eap_peap
      - wireless_dot1x_eap_peap/teardown
      - fingerbank_invalid_db/clear_cache
      - pfdhcplistener
      - pfdhcplistener/teardown
      - fingerbank_invalid_db/missing_table/teardown

  tasks:
    - name: Run Venom testsuites
      command: '{{ venom_dir }}/venom-wrapper.sh {{ venom_dir }}/test_suites/{{ item }}'
      args:
        chdir: '{{ venom_dir }}'
      loop: '{{ test_suites }}'
      vars:
        venom_wrapper_args:
          # temp, overcome two Venom issues:
          # - tap: https://github.com/ovh/venom/issues/428
          # - when running test suite one by one, previous logs and results are overriden
          # Venom will create one directory per test suite to store results
          VENOM_COMMON_FLAGS: '--format=tap --output-dir={{ venom_dir }}/results/{{ item }}'

      # add inventory__group_environment to Ansible environment
      # useful to make env vars available for Venom
      environment: '{{ inventory__group_environment | d({})
                       | combine(venom_wrapper_args | d({})) }}'


